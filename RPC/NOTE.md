# 分布式理论
## 1.分布式系统架构
### 1.分布式系统概念
```text
   分布式系统是一个硬件或软件组件分布在不同的网络计算机上，
批次之间仅仅通过消息传递进行通信和协调的系统。
```
集群：多个人在一起做同样的事。
分布式：多个人在一起做不同的事。

##### 分布式系统的特点
1. 分布性 
2. 对等性
3. 并发性
4. 缺乏全局时钟
5. 故障总会发生

### 2.分布式系统发展
```text
    去除IOE，I：IBM小型机，O：Oracle数据库，E：EMC高端存储
```
##### 为什么要去IOE？
1. 升级单机处理能力的性价比越来越低。
2. 单机处理能力存在瓶颈。
3. 稳定性和可用性这两个指标很难达到。

### 3.分布式架构的演变
阶段一：单应用架构
阶段二：应用服务器与数据库服务器分离
阶段三：应用服务器集群
阶段四：应用服务器负载客户
阶段五：数据库读写分离
阶段六：添加搜索引擎缓解读库压力
阶段七：添加缓存机制缓解数据库的压力
阶段八：数据库水平/垂直拆分
阶段九：应用拆分
阶段十：服务化

## 2.分布式系统面临的问题
1. 通信异常
   ```text
      网络本身的不可靠性，因此每次网络通信都会伴随着网络不可用的风险
   （光纤、路由、DNS等硬件设备或系统的可不用），都会导致最终分布式系
   统无法顺利进行一次网络通信，另外，即使分布式系统各节点之间的网络通
   信能够正常执行，其延时也会大于单机操作，存在巨大的延迟差别，也会影
   响消息的收发过程，因此消息丢失和消息延迟变得非常普遍。
   ```
2. 网络分区
   ```text
      网络之间出现了网络不连通，但各个子网络内部网络是正常的，从而导致
   整个系统的网络环境被切分成了若干个孤立的区域，分布式系统就会出现局部
   小集群，在极端情况下，这些小集群会独立完成原本需要整个分布式系统才能
   完成的功能，包括数据的事务处理，这就对分布式一致性提出非常大的挑战。
   ```
3. 节点故障
   ```text
      节点故障指的是组成分布式系统的服务器节点出现宕机或僵死的现象，
   根据经验来说，每个节点都有可能出现故障，并且经常发生。
   ```
4. 三态
   ```text
      分布式系统每一次请求与响应存在特有的“三态”概念：成功、失败、超时。
   分布式系统中，由于网络是不可靠的，虽然绝大部分情况下，网络通信能够接
   受到成功或失败的响应，但当网络出现异常的情况下，就会出现超时现象，通
   常有以下两种情况：   
       1. 由于网络原因，该请求并没有被成功的发送到接受方，而是在发送过
          程中发生了丢包现象。
       2. 该请求成功的被接收方接手后，并进行了处理，但在响应反馈给发送
          方过程中，发生了消息丢包现象。
   ```

## 分布式理论：一致性
### 1. 什么是分布式一致性
```text
分布式数据一致性，指的是数据在多份副本中存储时，各副本中的数据是一致的。
```
### 2. 副本一致性
```text
分布式系统有多态机器，每台机器上的数据就是一个副本，集群中每台机器的数据
一致就是副本一致性。
```
### 3. 一致性分类
1. 强一致性
   ```text
   这种一致性级别是最符合用户直觉的，它要求系统写入什么，读出来的也是什么，
   用户体验好，但实现起来往往对系统的性能影响大且很难实现
   ```
2. 弱一致性
   ```text
   这种一致性级别约束了系统在写入成功后，不承诺立即可以读到写入的数据，也不
   承诺多久之后数据能够到达一致，但会尽可能地保证到某个时间级别（比如秒级）
   后，数据能够达到一致状态。
   ``` 
   1. 读写一致性      
      ```text
      用户读取自己写入结果的一致性，保证用户永远能够第一时间看到自己更像的
      内容。
      
      解决方案：
          1. 对于一些特定的内容我们每次都去主库读取。（导致主库压力大）
          2. 设置一个更新时间窗口，在刚刚更新的一段时间内，我们默认都从主库
             读取，过了这个窗口之后，我们会挑选最近有过更新的从库进行读取。
          3. 我们直接记录用户更新的时间戳，在请求的时候把这个时间戳带上，
             凡是最后更新时间小于这个时间撮的从库都不予响应。
      ```
   2. 单调读一致性
      ```text
      本次读到的数据不能比上次读到的旧。
      由于主从节点更新数据的时间不一致，导致用户在不停刷新的时候，有时候能刷出来，
      再次刷新之后会发现数据不见了，再刷新又有可能再刷出来。
      
      解决方案：
         就是根据用户id计算一个hash值，再通过hash值映射到机器。同一个用户不管怎么
         刷新，都只会被映射到同一台机器上，这样就保证了不会读到其他从库的内容，带来
         用户体验不好的影响。
      ```   
   3. 因果一致性
      ```text
      指的是：如果节点A在更新完某个数据后通知了节点B，那么节点B之后对该数据的访问和
      修改都是基于A更新后的值。与此同时，和节点A无因果关系的节点C的数据访问则没有这
      样的限制。
      ```   
   4. 最终一致性
      ```text
      最终一致性是所有分布式一致性模型中最弱的。可以认为是没有任何优化的“最”弱一致性
      它的意思是说，不考虑所有的中间状态的影响，只保证当没有新的更新之后，经过一段时
      间之后，最终系统内所有副本的数据都是正确的。它最大程度上保证了系统的并发能力，
      也因此，在高并发的场景下，它也是使用最广的一致性模型。
      ```
      
      


